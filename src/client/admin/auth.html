<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
    <script src="./assets/security.js"></script>
    <title>NANU ID Auth Client @DEV@</title>
    <link rel="icon" href="./assets/favicon.png" type="image/x-icon">
    <script>
        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
        }

        function setLocalStorage(name, value) {
            localStorage.setItem(name, value);
        }

        function getUrlParameter(name) {
            const regex = new RegExp('[?&]' + name + '=([^&]*)');
            const results = regex.exec(window.location.search);
            return results ? decodeURIComponent(results[1]) : null;
        }
        async function fetchUserInfo(accessToken) {
            try {
                const response = await fetch('https://auth.nanu.cc/api/mypage', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 200) {
                    return await response.json(); 
                } else {
                    return null; 
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
                return null;
            }
        }

        async function refreshAccessToken(refreshToken) {
            try {
                const response = await fetch('https://auth.nanu.cc/api/oauth/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });

                if (response.status === 200) {
                    const data = await response.json();
                    setCookie('ACCESS', data.access_token, 1); 
                    return data.access_token;
                } else {
                    return null; 
                }
            } catch (error) {
                console.error('Error refreshing access token:', error);
                return null;
            }
        }

        // 페이지가 로드될 때 실행되는 함수
        window.onload = async function () {
            const accessToken = getUrlParameter('ACCESS');
            const refreshToken = getUrlParameter('REFRESH');

            if (accessToken && refreshToken) {
                setCookie('ACCESS', accessToken, 1); 
                setLocalStorage('REFRESH', refreshToken); 

                let userInfo = await fetchUserInfo(accessToken);

                if (!userInfo && refreshToken) {
                    // 액세스 토큰이 유효하지 않으면 리프레시 토큰으로 갱신 시도
                    const newAccessToken = await refreshAccessToken(refreshToken);
                    if (newAccessToken) {
                        userInfo = await fetchUserInfo(newAccessToken);
                    }
                }

                if (userInfo) {
                    window.location.href = './index.html'; 
                } else {
                    alert('Something is wrong. Please Check Your NANU ID Ops Status')
                }
            } else {
                alert('Something is wrong. Please Check Your NANU ID Ops Status')
            }
        }
    </script>
</head>

<body>
    <h1>NANU ID Auth</h1>
    <p>Please wait while we check your authentication status.</p>
</body>

</html>
